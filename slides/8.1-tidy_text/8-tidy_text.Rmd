---
title: "Intro to Text Mining: Tidy Text"
subtitle: ""
author: "Filippo Chiarello, Ph.D."
output:
  xaringan::moon_reader:
    css: ["xaringan-themer.css", "slides.css"]
    lib_dir: libs
    anchor_sections: FALSE
    nature:
      ratio: "16:9"
      highlightLines: false
      highlightStyle: solarized-ligth
      countIncrementalSlides: true
---

```{r child = "../setup.Rmd"}
```

## Tidy text 

* [tidytext](https://CRAN.R-project.org/package=tidytext) is an R package for analysing text with the [tidyverse](https://www.tidyverse.org/) philosophy
* treating **text as data frames** of individual words allows us to manipulate, summarize, and visualize the characteristics of text easily and integrate natural language processing into effective workflows of the tidyverse


---

## One-token-per-row

* we define the tidy text format as being a table with **one-token-per-row** 
* a **token** is a meaningful unit of text, such as a word, a sentence, or paragraph, that we are interested in using for analysis
* **tokenization** is the process of splitting text into tokens

---

## unnest_tokens

* `unnest_tokens` is the main verb of tidytext
* it splits text into tokens and outputs a one-token-per-row table
* takes 3 main parameters:
   1. tbl: a data frame containing the text to tokenize
   2. output: the output column to be created 
   3. input: the input column that gets split
* punctuation is stripped
* tokens are converted to lowercase
* other columns, such as the line number each word came from, are retained

---

## unnest_tokens

```{r}
# the tidy tools
library(tidyverse)

# the tidy tools for text
library(tidytext)

# Emily Dickinson wrote some lovely text in her time
text <- c("Because I could not stop for Death -",
          "He kindly stopped for me -",
          "The Carriage held but just Ourselves -",
          "and Immortality")


# a data frame with one row per sentence
text_df <- data_frame(line = 1:4, text = text)
```

---

# Let's print the table

```{r}
text_df

```


---
# tokenization: one row per word

```{r}

unnest_tokens(tbl = text_df, output = word, input = text)

```


---

## Stop words and stems

* **stop words** are words which are filtered out before processing of natural language data (text), such as such as *the*, *is*, *at*, *which*, *for*, *an* and *on*
* **stemming** is the process of reducing inflected words to their word stem, base or root form. For instance, a stemming algorithm might reduce the words *fishing*, *fished*, and *fisher* to the stem *fish*
* a popular stemmer is [Porter's stemming algorithm](https://en.wikipedia.org/wiki/Martin_Porter)

---
## Jane Austen's novels

* Let's use the text of [Jane Austen](https://it.wikipedia.org/wiki/Jane_Austen)'s 6 completed, published novels from the [janeaustenr](https://cran.r-project.org/package=janeaustenr) package, and transform them into a tidy format
* The janeaustenr package provides these texts in a **one-row-per-line** format, where a line is this context is analogous to a literal printed line in a physical book

---


## Jane Austen's novels

```{r}
library(janeaustenr)
library(stringr)

# one sentence per row
austen_books()

```


---

# Add line and chapter numbers relative to books

```{r}
original_books <- austen_books() %>%
  group_by(book) %>%
  mutate(linenumber = row_number(),
         chapter = cumsum(
           str_detect(text, regex("^chapter [\\divxlc]", ignore_case = TRUE)))) %>%
  ungroup()

original_books
```

---

# tokenize: one work per row

```{r}

tidy_books <- original_books %>%
  unnest_tokens(word, text)

tidy_books

```

---

# remove stop words

```{r}
stop_words
tidy_books <- tidy_books %>%
  anti_join(stop_words)

```

---

# word frequency

```{r}
tidy_books %>%
  count(word, sort = TRUE) 
```

---

# plot word frequency

```{r}

tidy_books %>%
  count(word, sort = TRUE) %>%
  filter(n > 600) %>%
  # reorder levels of factor word wrt n
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n)) +
  geom_col() +
  xlab(NULL) +
  coord_flip() +
  theme_bw()

```

---

# wordcloud

```{r}

library(wordcloud)

tidy_books %>%
  count(word) %>%
  # evaluate an R expression in an environment constructed from data
  with(wordcloud(word, n, max.words = 100))

```

---

# Porter's word stemming

```{r}

library(SnowballC)
tidy_books <- tidy_books %>%
  mutate(word = wordStem(word)) # stemming

tidy_books

```

---

# plot word frequency

```{r}

tidy_books %>%
  count(word, sort = TRUE) %>%
  filter(n > 600) %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n)) +
  geom_col() +
  xlab(NULL) +
  coord_flip() +
  theme_bw()

```

---

# tokenize by pattern (with regular expression)

```{r}

austen_chapters <- austen_books() %>%
  group_by(book) %>%
  unnest_tokens(chapter, text, 
                token = "regex", 
                pattern = "(Chapter|CHAPTER) [\\dIVXLC]{1,8}") %>%
  ungroup()

```

---

# how many chapters in each book?

```{r}

austen_chapters %>% 
  group_by(book) %>% 
  summarise(chapters = n()) %>% 
  arrange(-chapters)


```

---

## Project Gutenberg

* now that we've used the `janeaustenr` package to explore tidying text, let's introduce the [gutenbergr](https://github.com/ropenscilabs/gutenbergr) package 
* the `gutenbergr` package provides access to the public domain works from the [Project Gutenberg](https://www.gutenberg.org/) collection
* we will mostly use the function `gutenberg_download()` that downloads one or more works from Project Gutenberg by ID

---

## Project Gutenberg - H.G. Wells

Let's look at some science fiction and fantasy novels by [H.G. Wells](https://it.wikipedia.org/wiki/H._G._Wells), who lived in the late 19th and early 20th centuries. Let's get:

>* [*The Time Machine*](https://www.gutenberg.org/ebooks/35)
>* [*The War of the Worlds*](https://www.gutenberg.org/ebooks/36)
>* [*The Invisible Man*](https://www.gutenberg.org/ebooks/5230) 
>* [*The Island of Doctor Moreau*](https://www.gutenberg.org/ebooks/159)

---

Download the [RDS file](hgwells.rds).

```{r}
library(gutenbergr)

# run once and save the result as RDS
#hgwells <- gutenberg_download(c(35, 36, 5230, 159))
#write_rds(hgwells, "hgwells.rds")

# read from RDS
hgwells = read_rds("hgwells.rds")
hgwells

```

---
--- 


```{r}

tidy_hgwells <- hgwells %>%
  unnest_tokens(word, text) %>%
  anti_join(stop_words)

tidy_hgwells %>%
  count(word, sort = TRUE)

```


---


## Project Gutenberg - Bronte sisters

Now let's get some well-known works of the [Bronte sisters](https://it.wikipedia.org/wiki/Sorelle_Bront%C3%AB), whose lives overlapped with Jane Austen's somewhat but who wrote in a rather different style. Let's get: 

>* [*Jane Eyre*](https://www.gutenberg.org/ebooks/1260) 
>* [*Wuthering Heights*](https://www.gutenberg.org/ebooks/768) 
>* [*The Tenant of Wildfell Hall*](https://www.gutenberg.org/ebooks/969) 
>* [*Villette*](https://www.gutenberg.org/ebooks/9182) 
>* [*Agnes Grey*](https://www.gutenberg.org/ebooks/767)

---

Download the [RDS file](bronte.rds).

```{r}
# run once and save the result as RDS
# bronte <- gutenberg_download(c(1260, 768, 969, 9182, 767))
# write_rds(bronte, "bronte.rds")

# read from RDS
bronte = read_rds("bronte.rds")
bronte
```

---

```{r}

tidy_bronte <- bronte %>%
  unnest_tokens(word, text) %>%
  anti_join(stop_words)

tidy_bronte %>%
  count(word, sort = TRUE)

```

Interesting that "time", "eyes", and "hand" are in the top 10 for both H.G. Wells and the Bronte sisters.

---

## Compare words used by Jane Austen and the Bronte sisters

```{r}
frequency <- 
  bind_rows(mutate(tidy_bronte, author = "Bronte Sisters"),
                       mutate(tidy_hgwells, author = "H.G. Wells"), 
                       mutate(tidy_books, author = "Jane Austen")) %>% 
  mutate(word = str_extract(word, "[a-z']+")) %>%
  count(author, word) %>%
  group_by(author) %>%
  mutate(proportion = n / sum(n)) %>% 
  select(-n) %>% 
  spread(author, proportion) 

frequency
```

---
# About str_extract()

We use `str_extract()` here because the UTF-8 encoded texts from Project Gutenberg have some examples of words with 
underscores around them to indicate emphasis (like italics). 

---

## Compare words used by Jane Austen, the Bronte sisters, and H.G. Wells

Let's comparing the word frequencies of Jane Austen, the Bronte sisters, and H.G. Wells:

```{r}
library(scales)

# correlate frequencies of words in `BrontÃ« Sisters` and `Jane Austen` books
# expect a warning about rows with missing values being removed
graph <- ggplot(frequency, aes(x = `Bronte Sisters`, y = `Jane Austen`)) +
  geom_abline(color = "gray40", lty = 2) +
  geom_text(aes(label = word), check_overlap = TRUE, vjust = 1.5) +
  scale_x_log10(labels = percent_format()) +
  scale_y_log10(labels = percent_format()) +
  labs(y = "Jane Austen", x = "Bronte Sisters") +
  theme_bw()

```

---

```{r}

graph

```

---


## Compare words used by Jane Austen, the Bronte sisters, and H.G. Wells

Let's quantify how similar and different these sets of word frequencies are using a correlation test. How correlated are the word frequencies between Austen and the Bronte sisters, and between Austen and Wells?

```{r}
# quantify correlation
cor.test(frequency$`Bronte Sisters`,  frequency$`Jane Austen`)

```

---

```{r}
cor.test(frequency$`H.G. Wells`,  frequency$`Jane Austen`)

```

Just as we saw in the plots, the word frequencies are more correlated between the Austen and Bronte novels than between Austen and H.G. Wells.


<document>

<filing_date>
2020-06-29
</filing_date>

<publication_date>
2020-10-15
</publication_date>

<priority_date>
2018-04-27
</priority_date>

<ipc_classes>
G06F17/16,G06T3/00,G06T7/73
</ipc_classes>

<assignee>
TENCENT TECHNOLOGY (SHENZHEN) COMPANY
</assignee>

<inventors>
LIU WEI
BAO, LINCHAO
LIN, XIANGKAI
LING, YONGGEN
</inventors>

<docdb_family_id>
63748232
</docdb_family_id>

<title>
RELOCALIZATION METHOD AND APPARATUS IN CAMERA POSE TRACKING PROCESS AND STORAGE MEDIUM
</title>

<abstract>
This application discloses a repositioning method performed by an electronic device in a camera pose tracking process, belonging to the field of augmented reality (AR). The method includes: obtaining a current image acquired by the camera after an ith anchor image in a plurality of anchor images; obtaining an initial feature point and an initial pose parameter in a first anchor image in the plurality of anchor images in a case that the current image satisfies a repositioning condition; performing feature point tracking on the current image relative to the first anchor image, to obtain a target feature point; calculating a pose change amount of a camera from a first camera pose to a target camera pose according to the initial feature point and the target feature point; and performing repositioning according to the initial pose parameter and the pose change amount to obtain a target pose parameter.
</abstract>

<claims>
1. A repositioning method in a camera pose tracking process, applied to an electronic device having a camera, the electronic device being configured to sequentially perform camera pose tracking on a plurality of anchor images, the method comprising: obtaining a current image acquired by the camera after an ith anchor image in the plurality of anchor images, i being an integer greater than 1; obtaining an initial feature point and an initial pose parameter in a first anchor image in the plurality of anchor images in a case that the current image satisfies a repositioning condition, the initial pose parameter being used to indicate a camera pose of the camera during acquisition of the first anchor image; performing feature point tracking on the current image relative to the first anchor image, to obtain a target feature point matching the initial feature point; calculating a pose change amount of the camera from a first camera pose to a target camera pose according to the initial feature point and the target feature point, the target camera pose being a camera pose of the camera during acquisition of the current image; and performing repositioning according to the initial pose parameter and the pose change amount to obtain a target pose parameter corresponding to the target camera pose.
2. The method according to claim 1, wherein the electronic device is further provided with an inertial measurement unit (IMU); and the performing feature point tracking on the current image relative to the first anchor image, to obtain a target feature point matching the initial feature point comprises: extracting candidate feature points from the current image; obtaining a reference pose change amount of the camera during acquisition of the current image by using the IMU; performing rotation, translation, and projection on the initial feature point in the first anchor image according to the reference pose change amount, to obtain a projected feature point corresponding to the initial feature point in the current image; and searching the candidate feature points in a first range with the projected feature point being the center for a target feature point matching the initial feature point.
3. The method according to claim 2, wherein the performing rotation, translation, and projection on the initial feature point in the first anchor image according to the reference pose change amount, to obtain a projected feature point corresponding to the initial feature point in the current image comprises: obtaining two-dimensional coordinates of the initial feature point in the first anchor image; performing back projection on the two-dimensional coordinates of the initial feature point, to obtain first three-dimensional coordinates Xborn of the initial feature point in the three-dimensional space; performing three-dimensional rotation and translation on the first three-dimensional coordinates Xborn by using the following formula, to obtain second three-dimensional coordinates Xcurrent corresponding to the initial feature point in the current image,
description="In-line Formulae" end="lead"?Xcurrent=R*Xborn+T; anddescription="In-line Formulae" end="tail"? projecting the second three-dimensional coordinates Xcurrent projection to the current image, to obtain two-dimensional coordinates of the projected feature point in the current image, R being a rotation matrix in the reference pose change amount, and T being a displacement vector in the reference pose change amount.
4. The method according to claim 2, wherein after the searching a first range with the projected feature point being the center for a target feature point matching the initial feature point, the method further comprises: searching a second range with the projected feature point being the center again for the target feature point matching the initial feature point in a case that a quantity of the found target feature points is less than a preset threshold, the second range being larger than the first range.
5. The method according to claim 1, further comprising: obtaining n pyramid images with different scales corresponding to the first anchor image, n being an integer greater than 1; and extracting an initial feature point from each pyramid image, and recording two-dimensional coordinates of the initial feature point in a case that the pyramid image is scaled to the original size.
6. The method according to claim 1, wherein the calculating a pose change amount of the camera from a first camera pose to a target camera pose according to the initial feature point and the target feature point comprises: calculating a homography matrix of the camera in a camera pose change process according to the initial feature point and the target feature point; and decomposing the homography matrix, to obtain the pose change amount comprising Rrelocalize and Trelocalize of the change of the camera from the first camera pose to the target camera pose.
7. The method according to claim 1, wherein after the performing repositioning according to the initial pose parameter and the pose change amount to obtain a target pose parameter corresponding to the target camera pose, the method further comprises: determining the current image as an (i+1)th anchor image; and continuing to perform feature point tracking based on the (i+1)th anchor image.
8. An electronic device, comprising a memory and a processor, a camera, and a plurality of programs stored in the memory, wherein the plurality of programs, when executed by the processor, cause the electronic device to sequentially perform a process of camera pose tracking on a plurality of anchor images, the process including: obtaining a current image acquired by the camera after an ith anchor image in the plurality of anchor images, i being an integer greater than 1; obtaining an initial feature point and an initial pose parameter in a first anchor image in the plurality of anchor images in a case that the current image satisfies a repositioning condition, the initial pose parameter being used to indicate a camera pose of the camera during acquisition of the first anchor image; performing feature point tracking on the current image relative to the first anchor image, to obtain a target feature point matching the initial feature point; calculating a pose change amount of the camera from a first camera pose to a target camera pose according to the initial feature point and the target feature point, the target camera pose being a camera pose of the camera during acquisition of the current image; and performing repositioning according to the initial pose parameter and the pose change amount to obtain a target pose parameter corresponding to the target camera pose.
9. The electronic device according to claim 8, wherein the electronic device is further provided with an inertial measurement unit (IMU); and the performing feature point tracking on the current image relative to the first anchor image, to obtain a target feature point matching the initial feature point comprises: extracting candidate feature points from the current image; obtaining a reference pose change amount of the camera during acquisition of the current image by using the IMU; performing rotation, translation, and projection on the initial feature point in the first anchor image according to the reference pose change amount, to obtain a projected feature point corresponding to the initial feature point in the current image; and searching the candidate feature points in a first range with the projected feature point being the center for a target feature point matching the initial feature point.
10. The electronic device according to claim 9, wherein the performing rotation, translation, and projection on the initial feature point in the first anchor image according to the reference pose change amount, to obtain a projected feature point corresponding to the initial feature point in the current image comprises: obtaining two-dimensional coordinates of the initial feature point in the first anchor image; performing back projection on the two-dimensional coordinates of the initial feature point, to obtain first three-dimensional coordinates Xborn of the initial feature point in the three-dimensional space; performing three-dimensional rotation and translation on the first three-dimensional coordinates Xborn by using the following formula, to obtain second three-dimensional coordinates Xcurrent corresponding to the initial feature point in the current image,
description="In-line Formulae" end="lead"?Xcurrent=R*Xborn+T; anddescription="In-line Formulae" end="tail"? projecting the second three-dimensional coordinates Xcurrent projection to the current image, to obtain two-dimensional coordinates of the projected feature point in the current image, R being a rotation matrix in the reference pose change amount, and T being a displacement vector in the reference pose change amount.
11. The electronic device according to claim 9, wherein the process further comprises: after searching a first range with the projected feature point being the center for a target feature point matching the initial feature point: searching a second range with the projected feature point being the center again for the target feature point matching the initial feature point in a case that a quantity of the found target feature points is less than a preset threshold, the second range being larger than the first range.
12. The electronic device according to claim 8, wherein the process further comprises: obtaining n pyramid images with different scales corresponding to the first anchor image, n being an integer greater than 1; and extracting an initial feature point from each pyramid image, and recording two-dimensional coordinates of the initial feature point in a case that the pyramid image is scaled to the original size.
13. The electronic device according to claim 8, wherein the calculating a pose change amount of the camera from a first camera pose to a target camera pose according to the initial feature point and the target feature point comprises: calculating a homography matrix of the camera in a camera pose change process according to the initial feature point and the target feature point; and decomposing the homography matrix, to obtain the pose change amount comprising Rrelocalize and Trelocalize of the change of the camera from the first camera pose to the target camera pose.
14. The electronic device according to claim 8, wherein the process further comprises: after performing repositioning according to the initial pose parameter and the pose change amount to obtain the target pose parameter corresponding to the target camera pose: determining the current image as an (i+1)th anchor image; and continuing to perform feature point tracking based on the (i+1)th anchor image.
15. A non-transitory computer-readable storage medium storing instructions, the instructions, when executed by a processor of an electronic device having a camera, cause the electronic device to sequentially perform a process of camera pose tracking on a plurality of anchor images, the process including: obtaining a current image acquired by the camera after an ith anchor image in the plurality of anchor images, i being an integer greater than 1; obtaining an initial feature point and an initial pose parameter in a first anchor image in the plurality of anchor images in a case that the current image satisfies a repositioning condition, the initial pose parameter being used to indicate a camera pose of the camera during acquisition of the first anchor image; performing feature point tracking on the current image relative to the first anchor image, to obtain a target feature point matching the initial feature point; calculating a pose change amount of the camera from a first camera pose to a target camera pose according to the initial feature point and the target feature point, the target camera pose being a camera pose of the camera during acquisition of the current image; and performing repositioning according to the initial pose parameter and the pose change amount to obtain a target pose parameter corresponding to the target camera pose.
16. The non-transitory computer-readable storage medium according to claim 15, wherein the electronic device is further provided with an inertial measurement unit (IMU); and the performing feature point tracking on the current image relative to the first anchor image, to obtain a target feature point matching the initial feature point comprises: extracting candidate feature points from the current image; obtaining a reference pose change amount of the camera during acquisition of the current image by using the IMU; performing rotation, translation, and projection on the initial feature point in the first anchor image according to the reference pose change amount, to obtain a projected feature point corresponding to the initial feature point in the current image; and searching the candidate feature points in a first range with the projected feature point being the center for a target feature point matching the initial feature point.
17. The non-transitory computer-readable storage medium according to claim 16, wherein the performing rotation, translation, and projection on the initial feature point in the first anchor image according to the reference pose change amount, to obtain a projected feature point corresponding to the initial feature point in the current image comprises: obtaining two-dimensional coordinates of the initial feature point in the first anchor image; performing back projection on the two-dimensional coordinates of the initial feature point, to obtain first three-dimensional coordinates Xborn of the initial feature point in the three-dimensional space; performing three-dimensional rotation and translation on the first three-dimensional coordinates Xborn by using the following formula, to obtain second three-dimensional coordinates Xcurrent corresponding to the initial feature point in the current image,
description="In-line Formulae" end="lead"?Xcurrent=R*Xborn+T; anddescription="In-line Formulae" end="tail"? projecting the second three-dimensional coordinates Xcurrent projection to the current image, to obtain two-dimensional coordinates of the projected feature point in the current image, R being a rotation matrix in the reference pose change amount, and T being a displacement vector in the reference pose change amount.
18. The non-transitory computer-readable storage medium according to claim 16, wherein the process further comprises: after searching the first range with the projected feature point being the center for the target feature point matching the initial feature point: searching a second range with the projected feature point being the center again for the target feature point matching the initial feature point in a case that a quantity of the found target feature points is less than a preset threshold, the second range being larger than the first range.
19. The non-transitory computer-readable storage medium according to claim 15, wherein the process further comprises: obtaining n pyramid images with different scales corresponding to the first anchor image, n being an integer greater than 1; and extracting an initial feature point from each pyramid image, and recording two-dimensional coordinates of the initial feature point in a case that the pyramid image is scaled to the original size.
20. The non-transitory computer-readable storage medium according to claim 15, wherein the calculating a pose change amount of the camera from a first camera pose to a target camera pose according to the initial feature point and the target feature point comprises: calculating a homography matrix of the camera in a camera pose change process according to the initial feature point and the target feature point; and decomposing the homography matrix, to obtain the pose change amount comprising Rrelocalize and Trelocalize of the change of the camera from the first camera pose to the target camera pose.
</claims>
</document>
